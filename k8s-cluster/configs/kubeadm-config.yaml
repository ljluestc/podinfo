---
# Kubeadm Configuration for HA Control Plane
apiVersion: kubeadm.k8s.io/v1beta3
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: "10.0.0.10"
  bindPort: 6443
nodeRegistration:
  criSocket: unix:///var/run/containerd/containerd.sock
  imagePullPolicy: IfNotPresent
  kubeletExtraArgs:
    node-labels: "node-role.kubernetes.io/control-plane="
  taints:
    - key: node-role.kubernetes.io/control-plane
      effect: NoSchedule
---
apiVersion: kubeadm.k8s.io/v1beta3
kind: ClusterConfiguration
kubernetesVersion: v1.28.0
clusterName: "secure-k8s-cluster"
controlPlaneEndpoint: "k8s-api.example.com:6443"
certificatesDir: /etc/kubernetes/pki
imageRepository: registry.k8s.io
networking:
  dnsDomain: cluster.local
  serviceSubnet: "10.96.0.0/12"
  podSubnet: "10.244.0.0/16"

# API Server Configuration with Security Hardening
apiServer:
  extraArgs:
    # Enable audit logging
    audit-log-path: "/var/log/kubernetes/audit/audit.log"
    audit-log-maxage: "30"
    audit-log-maxbackup: "10"
    audit-log-maxsize: "100"
    audit-policy-file: "/etc/kubernetes/audit-policy.yaml"

    # Enable encryption at rest
    encryption-provider-config: "/etc/kubernetes/encryption-config.yaml"

    # Authentication and Authorization
    enable-admission-plugins: NodeRestriction,PodSecurity,AlwaysPullImages,ServiceAccount,NamespaceLifecycle,LimitRanger,ResourceQuota
    authorization-mode: Node,RBAC

    # OIDC Configuration for external authentication
    oidc-issuer-url: "https://accounts.google.com"
    oidc-client-id: "kubernetes"
    oidc-username-claim: "email"
    oidc-groups-claim: "groups"

    # Security settings
    anonymous-auth: "false"
    enable-bootstrap-token-auth: "true"
    profiling: "false"

    # Request handling
    max-requests-inflight: "400"
    max-mutating-requests-inflight: "200"
    request-timeout: "60s"

    # etcd settings
    etcd-servers: "https://10.0.0.10:2379,https://10.0.0.11:2379,https://10.0.0.12:2379"

  extraVolumes:
    - name: audit-log
      hostPath: /var/log/kubernetes/audit
      mountPath: /var/log/kubernetes/audit
      readOnly: false
    - name: audit-policy
      hostPath: /etc/kubernetes/audit-policy.yaml
      mountPath: /etc/kubernetes/audit-policy.yaml
      readOnly: true
    - name: encryption-config
      hostPath: /etc/kubernetes/encryption-config.yaml
      mountPath: /etc/kubernetes/encryption-config.yaml
      readOnly: true
  certSANs:
    - "k8s-api.example.com"
    - "10.0.0.10"
    - "10.0.0.11"
    - "10.0.0.12"
    - "127.0.0.1"
  timeoutForControlPlane: 4m0s

# Controller Manager Configuration
controllerManager:
  extraArgs:
    # Security settings
    profiling: "false"
    use-service-account-credentials: "true"

    # Certificate management
    cluster-signing-duration: "8760h"  # 1 year

    # Leader election
    leader-elect: "true"
    leader-elect-lease-duration: "15s"
    leader-elect-renew-deadline: "10s"
    leader-elect-retry-period: "2s"

    # Node lifecycle
    node-monitor-grace-period: "40s"
    node-monitor-period: "5s"
    pod-eviction-timeout: "5m"

    # Service account token
    service-account-private-key-file: "/etc/kubernetes/pki/sa.key"
    root-ca-file: "/etc/kubernetes/pki/ca.crt"

    # Enable certificate rotation
    feature-gates: "RotateKubeletServerCertificate=true"

# Scheduler Configuration
scheduler:
  extraArgs:
    profiling: "false"
    leader-elect: "true"
    feature-gates: "PodPriority=true,PodPreemption=true"

# etcd Configuration for HA
etcd:
  external:
    endpoints:
      - https://10.0.0.10:2379
      - https://10.0.0.11:2379
      - https://10.0.0.12:2379
    caFile: /etc/kubernetes/pki/etcd/ca.crt
    certFile: /etc/kubernetes/pki/etcd/server.crt
    keyFile: /etc/kubernetes/pki/etcd/server.key

---
apiVersion: kubeadm.k8s.io/v1beta3
kind: KubeletConfiguration
serverTLSBootstrap: true
rotateCertificates: true
cgroupDriver: systemd
protectKernelDefaults: true
streamingConnectionIdleTimeout: 5m
makeIPTablesUtilChains: true

# Security settings
authentication:
  anonymous:
    enabled: false
  webhook:
    cacheTTL: 2m0s
    enabled: true
  x509:
    clientCAFile: /etc/kubernetes/pki/ca.crt

authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 5m0s
    cacheUnauthorizedTTL: 30s

# Resource management
enforceNodeAllocatable:
  - pods
  - system-reserved
  - kube-reserved
systemReserved:
  cpu: "500m"
  memory: "1Gi"
  ephemeral-storage: "1Gi"
kubeReserved:
  cpu: "500m"
  memory: "1Gi"
  ephemeral-storage: "1Gi"

# Limits
maxPods: 110
podPidsLimit: 4096

# Logging
logging:
  format: json

# TLS
tlsCipherSuites:
  - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256
  - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
  - TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
  - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
