---
# Prometheus ServiceMonitor for Podinfo Metrics
# Configures Prometheus to scrape podinfo metrics
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: podinfo
  namespace: podinfo
  labels:
    app: podinfo
    release: prometheus
spec:
  selector:
    matchLabels:
      app: podinfo
  endpoints:
  - port: http-metrics
    interval: 15s
    path: /metrics
    scheme: http

---
# ServiceMonitor for Podinfo Stable Service
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: podinfo-stable
  namespace: podinfo
  labels:
    app: podinfo
    service: stable
    release: prometheus
spec:
  selector:
    matchLabels:
      app: podinfo
      service: stable
  endpoints:
  - port: http-metrics
    interval: 15s
    path: /metrics
    scheme: http
    relabelings:
    - sourceLabels: [__meta_kubernetes_pod_name]
      targetLabel: pod
    - sourceLabels: [__meta_kubernetes_namespace]
      targetLabel: namespace
    - sourceLabels: [__meta_kubernetes_service_name]
      targetLabel: service
      replacement: podinfo-stable

---
# ServiceMonitor for Podinfo Canary Service
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: podinfo-canary
  namespace: podinfo
  labels:
    app: podinfo
    service: canary
    release: prometheus
spec:
  selector:
    matchLabels:
      app: podinfo
      service: canary
  endpoints:
  - port: http-metrics
    interval: 15s
    path: /metrics
    scheme: http
    relabelings:
    - sourceLabels: [__meta_kubernetes_pod_name]
      targetLabel: pod
    - sourceLabels: [__meta_kubernetes_namespace]
      targetLabel: namespace
    - sourceLabels: [__meta_kubernetes_service_name]
      targetLabel: service
      replacement: podinfo-canary

---
# PrometheusRule for Podinfo Alerting
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: podinfo-alerts
  namespace: podinfo
  labels:
    app: podinfo
    prometheus: kube-prometheus
spec:
  groups:
  - name: podinfo.rules
    interval: 30s
    rules:
    # High error rate alert
    - alert: PodinfoHighErrorRate
      expr: |
        sum(rate(http_request_duration_seconds_count{job="podinfo",status=~"5.."}[5m]))
        /
        sum(rate(http_request_duration_seconds_count{job="podinfo"}[5m]))
        > 0.05
      for: 2m
      labels:
        severity: warning
        app: podinfo
      annotations:
        summary: "Podinfo high error rate detected"
        description: "Podinfo error rate is {{ $value | humanizePercentage }} (threshold: 5%)"

    # High latency alert
    - alert: PodinfoHighLatency
      expr: |
        histogram_quantile(0.95,
          sum(rate(http_request_duration_seconds_bucket{job="podinfo"}[5m])) by (le)
        ) > 0.5
      for: 2m
      labels:
        severity: warning
        app: podinfo
      annotations:
        summary: "Podinfo high latency detected"
        description: "Podinfo p95 latency is {{ $value }}s (threshold: 500ms)"

    # Low success rate alert
    - alert: PodinfoLowSuccessRate
      expr: |
        sum(rate(http_request_duration_seconds_count{job="podinfo",status=~"2.."}[5m]))
        /
        sum(rate(http_request_duration_seconds_count{job="podinfo"}[5m]))
        < 0.95
      for: 2m
      labels:
        severity: warning
        app: podinfo
      annotations:
        summary: "Podinfo low success rate detected"
        description: "Podinfo success rate is {{ $value | humanizePercentage }} (threshold: 95%)"

    # Pod down alert
    - alert: PodinfoInstanceDown
      expr: up{job="podinfo"} == 0
      for: 1m
      labels:
        severity: critical
        app: podinfo
      annotations:
        summary: "Podinfo instance down"
        description: "Podinfo instance {{ $labels.instance }} has been down for more than 1 minute"

    # Rollout failure alert
    - alert: PodinfoRolloutFailed
      expr: |
        increase(
          rollout_phase{namespace="podinfo",name="podinfo",phase="Degraded"}[5m]
        ) > 0
      for: 1m
      labels:
        severity: critical
        app: podinfo
      annotations:
        summary: "Podinfo rollout failed"
        description: "Podinfo rollout has entered degraded state"

    # Canary analysis failure alert
    - alert: PodinfoCanaryAnalysisFailed
      expr: |
        increase(
          analysis_run_phase{namespace="podinfo",phase="Failed"}[5m]
        ) > 0
      for: 1m
      labels:
        severity: warning
        app: podinfo
      annotations:
        summary: "Podinfo canary analysis failed"
        description: "Podinfo canary analysis has failed, automatic rollback should occur"

---
# Pod Disruption Budget for High Availability
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: podinfo
  namespace: podinfo
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: podinfo

---
# HorizontalPodAutoscaler for Podinfo
# Auto-scales based on CPU and memory usage
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: podinfo
  namespace: podinfo
spec:
  scaleTargetRef:
    apiVersion: argoproj.io/v1alpha1
    kind: Rollout
    name: podinfo
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 15
      - type: Pods
        value: 2
        periodSeconds: 15
      selectPolicy: Max
