---
# Namespace for conformance testing
apiVersion: v1
kind: Namespace
metadata:
  name: sonobuoy
  labels:
    name: sonobuoy
    pod-security.kubernetes.io/enforce: privileged
    pod-security.kubernetes.io/audit: privileged
    pod-security.kubernetes.io/warn: privileged

---
# ServiceAccount for Sonobuoy
apiVersion: v1
kind: ServiceAccount
metadata:
  name: sonobuoy-serviceaccount
  namespace: sonobuoy

---
# ClusterRoleBinding for Sonobuoy
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: sonobuoy-serviceaccount-cluster-admin
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: sonobuoy-serviceaccount
  namespace: sonobuoy

---
# ConfigMap for Sonobuoy configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: sonobuoy-config
  namespace: sonobuoy
data:
  config.json: |
    {
      "Description": "Kubernetes Cluster Conformance Testing",
      "UUID": "",
      "Version": "v0.57.1",
      "ResultsDir": "/tmp/sonobuoy",
      "Resources": [
        "apiservices",
        "certificatesigningrequests",
        "clusterrolebindings",
        "clusterroles",
        "componentstatuses",
        "configmaps",
        "controllerrevisions",
        "cronjobs",
        "daemonsets",
        "deployments",
        "endpoints",
        "ingresses",
        "jobs",
        "leases",
        "limitranges",
        "namespaces",
        "networkpolicies",
        "nodes",
        "persistentvolumeclaims",
        "persistentvolumes",
        "poddisruptionbudgets",
        "pods",
        "podlogs",
        "podsecuritypolicies",
        "podtemplates",
        "replicasets",
        "replicationcontrollers",
        "resourcequotas",
        "rolebindings",
        "roles",
        "secrets",
        "servergroups",
        "serverversion",
        "services",
        "statefulsets",
        "storageclasses",
        "volumeattachments"
      ],
      "Filters": {
        "Namespaces": ".*",
        "LabelSelector": ""
      },
      "Limits": {
        "PodLogs": {
          "Namespaces": "kube-system,sonobuoy",
          "SonobuoyNamespace": true,
          "FieldSelectors": [],
          "LabelSelector": "",
          "Previous": false,
          "SinceSeconds": null,
          "SinceTime": null,
          "Timestamps": false,
          "TailLines": null,
          "LimitBytes": null
        }
      },
      "Server": {
        "advertiseaddress": "",
        "bindaddress": "0.0.0.0",
        "bindport": 8080,
        "timeoutseconds": 21600
      },
      "Plugins": [
        {
          "name": "e2e"
        }
      ],
      "PluginSearchPath": [
        "./plugins.d",
        "/etc/sonobuoy/plugins.d",
        "~/sonobuoy/plugins.d"
      ],
      "Namespace": "sonobuoy",
      "WorkerImage": "sonobuoy/sonobuoy:v0.57.1",
      "ImagePullPolicy": "IfNotPresent",
      "ImagePullSecrets": "",
      "ProgressUpdatesPort": "8099"
    }

---
# CronJob for scheduled conformance testing
apiVersion: batch/v1
kind: CronJob
metadata:
  name: sonobuoy-conformance
  namespace: sonobuoy
spec:
  schedule: "0 2 * * 0"  # Weekly on Sunday at 2 AM
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: sonobuoy-conformance
        spec:
          serviceAccountName: sonobuoy-serviceaccount
          restartPolicy: OnFailure
          containers:
          - name: sonobuoy
            image: sonobuoy/sonobuoy:v0.57.1
            imagePullPolicy: IfNotPresent
            command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "Starting Sonobuoy conformance test..."

              # Run quick conformance (not full certified-conformance for faster execution)
              sonobuoy run \
                --mode=quick \
                --wait \
                --log_dir=/tmp/sonobuoy/logs \
                --plugin=e2e

              # Wait for completion
              sonobuoy status --json | jq -r '.status'

              # Retrieve and display results
              results=$(sonobuoy retrieve /tmp/sonobuoy/)
              sonobuoy results $results

              # Cleanup
              sonobuoy delete --wait

              echo "Conformance test completed"
            volumeMounts:
            - name: results
              mountPath: /tmp/sonobuoy
          volumes:
          - name: results
            emptyDir: {}

---
# Job for manual conformance test execution
apiVersion: batch/v1
kind: Job
metadata:
  name: sonobuoy-quick-test
  namespace: sonobuoy
  labels:
    app: sonobuoy
    test-type: quick
spec:
  backoffLimit: 2
  ttlSecondsAfterFinished: 86400  # Keep for 24 hours
  template:
    metadata:
      labels:
        app: sonobuoy
        test-type: quick
    spec:
      serviceAccountName: sonobuoy-serviceaccount
      restartPolicy: Never
      containers:
      - name: sonobuoy
        image: sonobuoy/sonobuoy:v0.57.1
        imagePullPolicy: IfNotPresent
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Running Sonobuoy quick conformance test..."

          sonobuoy run --mode=quick --wait

          # Check status
          sonobuoy status

          # Retrieve results
          outfile=$(sonobuoy retrieve)
          echo "Results saved to: $outfile"

          # Display summary
          sonobuoy results $outfile

          echo "Test completed successfully"
        env:
        - name: SONOBUOY_NAMESPACE
          value: sonobuoy
