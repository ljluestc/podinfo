---
# ConfigMap with k6 load test script
apiVersion: v1
kind: ConfigMap
metadata:
  name: k6-test-script
  namespace: load-testing
data:
  basic-load-test.js: |
    import http from 'k6/http';
    import { check, sleep } from 'k6';
    import { Rate } from 'k6/metrics';

    // Custom metrics
    const errorRate = new Rate('errors');

    export const options = {
      stages: [
        { duration: '2m', target: 10 },   // Ramp up to 10 users
        { duration: '5m', target: 10 },   // Stay at 10 users
        { duration: '2m', target: 50 },   // Ramp up to 50 users
        { duration: '5m', target: 50 },   // Stay at 50 users
        { duration: '2m', target: 100 },  // Ramp up to 100 users
        { duration: '5m', target: 100 },  // Stay at 100 users
        { duration: '5m', target: 0 },    // Ramp down to 0 users
      ],
      thresholds: {
        'http_req_duration': ['p(95)<500', 'p(99)<1000'],
        'http_req_failed': ['rate<0.1'],
        'errors': ['rate<0.1'],
      },
    };

    const BASE_URL = __ENV.TARGET_URL || 'http://podinfo.default.svc.cluster.local:9898';

    export default function () {
      // Test health endpoint
      let healthRes = http.get(`${BASE_URL}/healthz`);
      check(healthRes, {
        'health check status is 200': (r) => r.status === 200,
      }) || errorRate.add(1);

      sleep(1);

      // Test metrics endpoint
      let metricsRes = http.get(`${BASE_URL}/metrics`);
      check(metricsRes, {
        'metrics status is 200': (r) => r.status === 200,
      }) || errorRate.add(1);

      sleep(1);

      // Test API endpoint
      let apiRes = http.get(`${BASE_URL}/api/info`);
      check(apiRes, {
        'api status is 200': (r) => r.status === 200,
        'api response has version': (r) => r.json('version') !== undefined,
      }) || errorRate.add(1);

      sleep(2);
    }

  stress-test.js: |
    import http from 'k6/http';
    import { check, sleep } from 'k6';

    export const options = {
      stages: [
        { duration: '1m', target: 50 },
        { duration: '3m', target: 50 },
        { duration: '1m', target: 100 },
        { duration: '3m', target: 100 },
        { duration: '1m', target: 200 },
        { duration: '3m', target: 200 },
        { duration: '1m', target: 500 },
        { duration: '5m', target: 500 },
        { duration: '5m', target: 0 },
      ],
      thresholds: {
        'http_req_duration': ['p(95)<1000'],
        'http_req_failed': ['rate<0.2'],
      },
    };

    const BASE_URL = __ENV.TARGET_URL || 'http://podinfo.default.svc.cluster.local:9898';

    export default function () {
      const res = http.get(`${BASE_URL}/`);
      check(res, {
        'status is 200': (r) => r.status === 200,
      });
      sleep(Math.random() * 3);
    }

  spike-test.js: |
    import http from 'k6/http';
    import { check, sleep } from 'k6';

    export const options = {
      stages: [
        { duration: '10s', target: 10 },
        { duration: '1m', target: 10 },
        { duration: '10s', target: 1000 },  // Spike!
        { duration: '3m', target: 1000 },
        { duration: '10s', target: 10 },
        { duration: '3m', target: 10 },
        { duration: '10s', target: 0 },
      ],
    };

    const BASE_URL = __ENV.TARGET_URL || 'http://podinfo.default.svc.cluster.local:9898';

    export default function () {
      const res = http.get(`${BASE_URL}/healthz`);
      check(res, { 'status is 200': (r) => r.status === 200 });
      sleep(1);
    }

---
# Job for basic load testing with k6
apiVersion: batch/v1
kind: Job
metadata:
  name: k6-basic-load-test
  namespace: load-testing
spec:
  backoffLimit: 0
  ttlSecondsAfterFinished: 3600
  template:
    metadata:
      labels:
        app: k6-load-test
    spec:
      restartPolicy: Never
      containers:
      - name: k6
        image: grafana/k6:latest
        command:
        - k6
        - run
        - --out
        - json=/results/basic-load-test-results.json
        - /scripts/basic-load-test.js
        env:
        - name: TARGET_URL
          value: "http://podinfo.default.svc.cluster.local:9898"
        volumeMounts:
        - name: scripts
          mountPath: /scripts
        - name: results
          mountPath: /results
        resources:
          requests:
            cpu: 500m
            memory: 512Mi
          limits:
            cpu: 1000m
            memory: 1Gi
      volumes:
      - name: scripts
        configMap:
          name: k6-test-script
      - name: results
        emptyDir: {}

---
# CronJob for scheduled load testing
apiVersion: batch/v1
kind: CronJob
metadata:
  name: k6-scheduled-load-test
  namespace: load-testing
spec:
  schedule: "0 4 * * *"  # Daily at 4 AM
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: k6-load-test
        spec:
          restartPolicy: Never
          containers:
          - name: k6
            image: grafana/k6:latest
            command:
            - k6
            - run
            - --out
            - json=/results/scheduled-test-results.json
            - /scripts/basic-load-test.js
            env:
            - name: TARGET_URL
              value: "http://podinfo.default.svc.cluster.local:9898"
            - name: K6_VUS
              value: "50"
            - name: K6_DURATION
              value: "5m"
            volumeMounts:
            - name: scripts
              mountPath: /scripts
            - name: results
              mountPath: /results
            resources:
              requests:
                cpu: 500m
                memory: 512Mi
              limits:
                cpu: 1000m
                memory: 1Gi
          volumes:
          - name: scripts
            configMap:
              name: k6-test-script
          - name: results
            emptyDir: {}
