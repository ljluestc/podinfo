---
# ServiceAccount for kube-hunter
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kube-hunter
  namespace: security-testing

---
# ClusterRole for kube-hunter
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: kube-hunter
rules:
- apiGroups: [""]
  resources: ["pods", "pods/log", "services", "nodes"]
  verbs: ["get", "list"]
- apiGroups: ["apps"]
  resources: ["deployments", "daemonsets", "statefulsets"]
  verbs: ["get", "list"]
- apiGroups: ["batch"]
  resources: ["jobs", "cronjobs"]
  verbs: ["get", "list"]
- apiGroups: [""]
  resources: ["secrets", "configmaps"]
  verbs: ["get", "list"]
- apiGroups: ["rbac.authorization.k8s.io"]
  resources: ["roles", "rolebindings", "clusterroles", "clusterrolebindings"]
  verbs: ["get", "list"]

---
# ClusterRoleBinding for kube-hunter
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kube-hunter
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kube-hunter
subjects:
- kind: ServiceAccount
  name: kube-hunter
  namespace: security-testing

---
# Job to run kube-hunter in pod mode (internal network scan)
apiVersion: batch/v1
kind: Job
metadata:
  name: kube-hunter-internal
  namespace: security-testing
spec:
  template:
    metadata:
      labels:
        app: kube-hunter
        mode: internal
    spec:
      serviceAccountName: kube-hunter
      restartPolicy: Never
      containers:
      - name: kube-hunter
        image: aquasec/kube-hunter:latest
        command: ["kube-hunter"]
        args: ["--pod", "--report", "json", "--log", "info"]
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 200m
            memory: 256Mi

---
# Job to run kube-hunter in CIDR mode (network scan)
apiVersion: batch/v1
kind: Job
metadata:
  name: kube-hunter-network
  namespace: security-testing
spec:
  template:
    metadata:
      labels:
        app: kube-hunter
        mode: network
    spec:
      serviceAccountName: kube-hunter
      restartPolicy: Never
      containers:
      - name: kube-hunter
        image: aquasec/kube-hunter:latest
        command: ["kube-hunter"]
        args:
        - "--cidr"
        - "10.0.0.0/8"  # Adjust to your cluster's CIDR
        - "--report"
        - "json"
        - "--log"
        - "info"
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 200m
            memory: 256Mi

---
# CronJob for scheduled kube-hunter scans
apiVersion: batch/v1
kind: CronJob
metadata:
  name: kube-hunter-scheduled
  namespace: security-testing
spec:
  schedule: "0 2 * * 1"  # Weekly on Monday at 2 AM
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: kube-hunter
            scheduled: "true"
        spec:
          serviceAccountName: kube-hunter
          restartPolicy: OnFailure
          containers:
          - name: kube-hunter
            image: aquasec/kube-hunter:latest
            command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "Running kube-hunter security scan..."

              # Run scan and save results
              kube-hunter --pod --report json --log info > /tmp/kube-hunter-results.json

              # Display summary
              echo "=== Kube-hunter Results Summary ==="
              cat /tmp/kube-hunter-results.json | jq -r '.vulnerabilities | length' | xargs -I {} echo "Vulnerabilities found: {}"

              # Check for high severity vulnerabilities
              HIGH_SEVERITY=$(cat /tmp/kube-hunter-results.json | jq -r '[.vulnerabilities[] | select(.severity == "high")] | length')
              echo "High severity vulnerabilities: $HIGH_SEVERITY"

              if [ "$HIGH_SEVERITY" -gt "0" ]; then
                echo "WARNING: High severity vulnerabilities detected!"
                cat /tmp/kube-hunter-results.json | jq -r '.vulnerabilities[] | select(.severity == "high")'
              fi

              echo "Security scan completed"
            resources:
              limits:
                cpu: 500m
                memory: 512Mi
              requests:
                cpu: 200m
                memory: 256Mi
