---
# Namespace for regression testing
apiVersion: v1
kind: Namespace
metadata:
  name: regression-testing
  labels:
    name: regression-testing

---
# ConfigMap with regression test scripts
apiVersion: v1
kind: ConfigMap
metadata:
  name: regression-test-scripts
  namespace: regression-testing
data:
  regression-suite.sh: |
    #!/bin/bash
    set -e

    echo "=== Running Regression Test Suite ==="

    TEST_RESULTS_DIR="/tmp/regression-results"
    mkdir -p $TEST_RESULTS_DIR

    FAILED_TESTS=0
    PASSED_TESTS=0

    # Function to run a test and track results
    run_test() {
      TEST_NAME=$1
      TEST_COMMAND=$2

      echo ""
      echo "Running: $TEST_NAME"
      echo "=========================================="

      if eval "$TEST_COMMAND" > "$TEST_RESULTS_DIR/$TEST_NAME.log" 2>&1; then
        echo "✓ PASS: $TEST_NAME"
        PASSED_TESTS=$((PASSED_TESTS + 1))
      else
        echo "✗ FAIL: $TEST_NAME"
        cat "$TEST_RESULTS_DIR/$TEST_NAME.log"
        FAILED_TESTS=$((FAILED_TESTS + 1))
      fi
    }

    # Regression Test 1: API Server Availability
    run_test "api-server-availability" "kubectl cluster-info"

    # Regression Test 2: Node Health
    run_test "node-health" "kubectl get nodes | grep -v NotReady"

    # Regression Test 3: Pod Scheduling
    run_test "pod-scheduling" "kubectl run test-pod-$RANDOM --image=nginx:alpine --restart=Never --rm -i --command -- echo 'test'"

    # Regression Test 4: Service Discovery
    run_test "service-discovery" "kubectl run test-dns-$RANDOM --image=busybox:latest --restart=Never --rm -i -- nslookup kubernetes.default.svc.cluster.local"

    # Regression Test 5: Persistent Volume Claims
    run_test "pvc-creation" "kubectl apply -f /tests/test-pvc.yaml && kubectl delete -f /tests/test-pvc.yaml"

    # Regression Test 6: Network Connectivity
    run_test "network-connectivity" "kubectl run test-net-$RANDOM --image=curlimages/curl:latest --restart=Never --rm -i -- curl -s http://kubernetes.default.svc.cluster.local:443"

    # Regression Test 7: RBAC Functionality
    run_test "rbac-functionality" "kubectl auth can-i get pods --as=system:serviceaccount:default:default"

    # Regression Test 8: Secrets Management
    run_test "secrets-management" "kubectl create secret generic test-secret-$RANDOM --from-literal=key=value --dry-run=client -o yaml | kubectl apply -f - && kubectl delete secret test-secret-* --all-namespaces"

    # Regression Test 9: ConfigMap Functionality
    run_test "configmap-functionality" "kubectl create configmap test-cm-$RANDOM --from-literal=key=value --dry-run=client -o yaml | kubectl apply -f - && kubectl delete configmap test-cm-* --all-namespaces"

    # Regression Test 10: Resource Quotas
    run_test "resource-quotas" "kubectl get resourcequotas --all-namespaces"

    # Summary
    echo ""
    echo "=========================================="
    echo "=== Regression Test Summary ==="
    echo "Passed: $PASSED_TESTS"
    echo "Failed: $FAILED_TESTS"
    echo "Total:  $((PASSED_TESTS + FAILED_TESTS))"
    echo "=========================================="

    if [ "$FAILED_TESTS" -gt "0" ]; then
      echo "Some regression tests failed!"
      exit 1
    fi

    echo "All regression tests passed!"

  test-pvc.yaml: |
    apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: test-pvc
      namespace: regression-testing
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 1Gi

  upgrade-regression.sh: |
    #!/bin/bash
    set -e

    echo "=== Post-Upgrade Regression Tests ==="

    # Test 1: Verify existing resources still exist
    echo "Test 1: Existing Resources"
    kubectl get all --all-namespaces > /tmp/all-resources.txt
    echo "✓ All resources listed"

    # Test 2: Verify existing pods are running
    echo "Test 2: Pod Status"
    NOT_RUNNING=$(kubectl get pods --all-namespaces --field-selector=status.phase!=Running,status.phase!=Succeeded --no-headers | wc -l)
    echo "Pods not running/succeeded: $NOT_RUNNING"

    # Test 3: Verify API version compatibility
    echo "Test 3: API Versions"
    kubectl api-versions
    echo "✓ API versions available"

    # Test 4: Verify Custom Resource Definitions
    echo "Test 4: CRDs"
    kubectl get crds
    echo "✓ CRDs checked"

    # Test 5: Verify cluster functionality
    echo "Test 5: Cluster Functionality"
    kubectl run upgrade-test-$RANDOM --image=nginx:alpine --restart=Never --rm -i --command -- echo "Upgrade test"
    echo "✓ Pod creation works"

    echo "=== Post-Upgrade Regression Complete ==="

  performance-regression.sh: |
    #!/bin/bash
    set -e

    echo "=== Performance Regression Tests ==="

    # Test 1: API Server Response Time
    echo "Test 1: API Server Response Time"
    for i in {1..10}; do
      time kubectl get nodes > /dev/null
    done

    # Test 2: Pod Startup Time
    echo "Test 2: Pod Startup Time"
    START_TIME=$(date +%s)
    kubectl run perf-test-$RANDOM --image=nginx:alpine --restart=Never
    kubectl wait --for=condition=Ready pod -l run=perf-test --timeout=60s
    END_TIME=$(date +%s)
    DURATION=$((END_TIME - START_TIME))
    echo "Pod startup time: ${DURATION}s"
    kubectl delete pod -l run=perf-test

    # Test 3: Deployment Rollout Time
    echo "Test 3: Deployment Rollout Time"
    kubectl create deployment perf-test --image=nginx:alpine --replicas=10
    START_TIME=$(date +%s)
    kubectl rollout status deployment/perf-test --timeout=120s
    END_TIME=$(date +%s)
    DURATION=$((END_TIME - START_TIME))
    echo "Rollout time: ${DURATION}s"
    kubectl delete deployment perf-test

    echo "=== Performance Regression Complete ==="

---
# CronJob for scheduled regression testing
apiVersion: batch/v1
kind: CronJob
metadata:
  name: regression-tests
  namespace: regression-testing
spec:
  schedule: "0 6 * * *"  # Daily at 6 AM
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: regression-test
        spec:
          serviceAccountName: default
          restartPolicy: OnFailure
          containers:
          - name: regression-test
            image: bitnami/kubectl:latest
            command: ["/bin/bash", "/scripts/regression-suite.sh"]
            volumeMounts:
            - name: scripts
              mountPath: /scripts
            - name: tests
              mountPath: /tests
            resources:
              limits:
                cpu: 500m
                memory: 512Mi
              requests:
                cpu: 200m
                memory: 256Mi
          volumes:
          - name: scripts
            configMap:
              name: regression-test-scripts
              defaultMode: 0755
          - name: tests
            configMap:
              name: regression-test-scripts

---
# Job for manual regression testing
apiVersion: batch/v1
kind: Job
metadata:
  name: regression-test-manual
  namespace: regression-testing
spec:
  backoffLimit: 1
  ttlSecondsAfterFinished: 3600
  template:
    metadata:
      labels:
        app: regression-test
        type: manual
    spec:
      serviceAccountName: default
      restartPolicy: Never
      containers:
      - name: regression-test
        image: bitnami/kubectl:latest
        command: ["/bin/bash", "/scripts/regression-suite.sh"]
        volumeMounts:
        - name: scripts
          mountPath: /scripts
        - name: tests
          mountPath: /tests
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 200m
            memory: 256Mi
      volumes:
      - name: scripts
        configMap:
          name: regression-test-scripts
          defaultMode: 0755
      - name: tests
        configMap:
          name: regression-test-scripts
