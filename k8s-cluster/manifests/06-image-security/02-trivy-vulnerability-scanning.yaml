---
# Trivy Operator for Comprehensive Vulnerability Scanning
# Automatically scans all images in the cluster for vulnerabilities

# Install via Helm:
# helm repo add aqua https://aquasecurity.github.io/helm-charts/
# helm install trivy-operator aqua/trivy-operator \
#   --namespace trivy-system \
#   --create-namespace \
#   --set="trivy.ignoreUnfixed=false" \
#   --set="operator.scanJobTimeout=10m" \
#   --set="trivy.severity=UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL"

---
# Namespace for Trivy
apiVersion: v1
kind: Namespace
metadata:
  name: trivy-system
  labels:
    name: trivy-system
    pod-security.kubernetes.io/enforce: restricted

---
# Trivy ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: trivy-operator-config
  namespace: trivy-system
data:
  # Scan configuration
  trivy.severity: "UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL"
  trivy.ignoreUnfixed: "false"
  trivy.timeout: "5m"
  trivy.mode: "Standalone"

  # Vulnerability database
  trivy.dbRepository: "ghcr.io/aquasecurity/trivy-db"
  trivy.javaDbRepository: "ghcr.io/aquasecurity/trivy-java-db"

  # Scanner configuration
  scanJob.timeout: "10m"
  scanJob.ttlSecondsAfterFinished: "3600"

  # Compliance standards
  compliance.failEntriesLimit: "10"

  # Report configuration
  vulnerabilityReports.scanner: "Trivy"

---
# Trivy Vulnerability Thresholds Policy
apiVersion: v1
kind: ConfigMap
metadata:
  name: trivy-policy
  namespace: trivy-system
data:
  policy.yaml: |
    # Vulnerability policy configuration
    maxCriticalVulnerabilities: 0
    maxHighVulnerabilities: 0
    maxMediumVulnerabilities: 5
    maxLowVulnerabilities: 20

    # Ignore specific CVEs (use sparingly!)
    ignoredCVEs:
      # Example: CVE with false positive
      # - CVE-2023-12345

    # Severity definitions
    severityLevels:
      CRITICAL:
        action: block
        notify: true
      HIGH:
        action: block
        notify: true
      MEDIUM:
        action: warn
        notify: true
      LOW:
        action: log
        notify: false
      UNKNOWN:
        action: log
        notify: false

---
# Trivy ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: trivy-operator
  namespace: trivy-system
automountServiceAccountToken: true

---
# Trivy ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: trivy-operator-role
rules:
# Read all resources for scanning
- apiGroups:
  - ""
  resources:
  - pods
  - pods/log
  - replicationcontrollers
  - services
  - resourcequotas
  - limitranges
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - apps
  resources:
  - deployments
  - daemonsets
  - replicasets
  - statefulsets
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - batch
  resources:
  - jobs
  - cronjobs
  verbs:
  - get
  - list
  - watch
  - create
  - delete
- apiGroups:
  - rbac.authorization.k8s.io
  resources:
  - roles
  - rolebindings
  - clusterroles
  - clusterrolebindings
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - networking.k8s.io
  resources:
  - networkpolicies
  - ingresses
  verbs:
  - get
  - list
  - watch
# Trivy CRDs
- apiGroups:
  - aquasecurity.github.io
  resources:
  - vulnerabilityreports
  - configauditreports
  - clusterconfigauditreports
  - rbacassessmentreports
  - clusterrbacassessmentreports
  - exposedsecretreports
  - sbomreports
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - delete

---
# Trivy ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: trivy-operator-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: trivy-operator-role
subjects:
- kind: ServiceAccount
  name: trivy-operator
  namespace: trivy-system

---
# ValidatingWebhookConfiguration for Trivy
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: trivy-admission-webhook
  labels:
    app: trivy-operator
webhooks:
- name: scanning.trivy.aquasecurity.github.io
  admissionReviewVersions:
  - v1
  - v1beta1
  clientConfig:
    service:
      name: trivy-operator-webhook
      namespace: trivy-system
      path: /validate
      port: 443
    caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN...  # Add actual CA bundle
  rules:
  - operations:
    - CREATE
    - UPDATE
    apiGroups:
    - ""
    apiVersions:
    - v1
    resources:
    - pods
  - operations:
    - CREATE
    - UPDATE
    apiGroups:
    - apps
    apiVersions:
    - v1
    resources:
    - deployments
    - replicasets
    - statefulsets
    - daemonsets
  - operations:
    - CREATE
    - UPDATE
    apiGroups:
    - batch
    apiVersions:
    - v1
    resources:
    - jobs
    - cronjobs
  failurePolicy: Fail
  matchPolicy: Equivalent
  namespaceSelector:
    matchExpressions:
    # Only scan non-system namespaces
    - key: kubernetes.io/metadata.name
      operator: NotIn
      values:
      - kube-system
      - kube-public
      - kube-node-lease
      - trivy-system
      - harbor-system
      - cosign-system
  sideEffects: None
  timeoutSeconds: 30

---
# Trivy Scan Job Template
apiVersion: batch/v1
kind: Job
metadata:
  name: trivy-scan-cluster
  namespace: trivy-system
spec:
  template:
    metadata:
      labels:
        app: trivy-scanner
    spec:
      serviceAccountName: trivy-operator
      restartPolicy: Never
      containers:
      - name: trivy
        image: aquasec/trivy:0.48.0
        command:
        - sh
        - -c
        - |
          #!/bin/sh
          set -e

          echo "Starting Trivy cluster scan..."

          # Update vulnerability database
          trivy image --download-db-only

          # Scan all images in the cluster
          kubectl get pods --all-namespaces -o json | \
          jq -r '.items[] | select(.status.phase=="Running") | .spec.containers[].image' | \
          sort -u | \
          while read image; do
            echo "Scanning image: $image"
            trivy image --severity HIGH,CRITICAL --exit-code 0 --format json "$image" > "/tmp/$(echo $image | tr '/:' '_').json"
          done

          echo "Cluster scan complete!"

          # Generate summary report
          cat > /tmp/scan-summary.txt <<EOF
          Trivy Cluster Scan Summary
          =========================
          Scan Date: $(date)
          Total Images Scanned: $(kubectl get pods --all-namespaces -o json | jq -r '.items[] | select(.status.phase=="Running") | .spec.containers[].image' | sort -u | wc -l)

          Vulnerability Summary:
          $(for f in /tmp/*.json; do
            if [ -f "$f" ]; then
              jq -r '.Results[]? | .Vulnerabilities[]? | .Severity' "$f" 2>/dev/null || true
            fi
          done | sort | uniq -c | sort -rn)
          EOF

          cat /tmp/scan-summary.txt
        volumeMounts:
        - name: scan-results
          mountPath: /tmp
      volumes:
      - name: scan-results
        emptyDir: {}

---
# CronJob for periodic scanning
apiVersion: batch/v1
kind: CronJob
metadata:
  name: trivy-periodic-scan
  namespace: trivy-system
spec:
  schedule: "0 2 * * *"  # Run daily at 2 AM
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: trivy-scanner
        spec:
          serviceAccountName: trivy-operator
          restartPolicy: Never
          containers:
          - name: trivy
            image: aquasec/trivy:0.48.0
            command:
            - sh
            - -c
            - |
              #!/bin/sh
              set -e

              echo "Starting scheduled Trivy scan..."

              # Update database
              trivy image --download-db-only

              # Scan all running images
              kubectl get pods --all-namespaces -o json | \
              jq -r '.items[] | select(.status.phase=="Running") | .spec.containers[].image' | \
              sort -u | \
              while read image; do
                echo "Scanning: $image"
                trivy image --severity HIGH,CRITICAL --format json "$image" | \
                  kubectl create configmap "scan-$(echo $image | tr '/:' '-' | cut -c1-50)-$(date +%s)" \
                    --from-file=scan.json=/dev/stdin \
                    --namespace=trivy-system || true
              done

              echo "Scheduled scan complete"

---
# PrometheusRule for Trivy alerts
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: trivy-alerts
  namespace: trivy-system
  labels:
    prometheus: kube-prometheus
spec:
  groups:
  - name: trivy-vulnerabilities
    interval: 5m
    rules:
    - alert: CriticalVulnerabilitiesDetected
      expr: |
        sum(trivy_image_vulnerabilities{severity="CRITICAL"}) > 0
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "Critical vulnerabilities detected in images"
        description: "{{ $value }} CRITICAL vulnerabilities found in container images"

    - alert: HighVulnerabilitiesDetected
      expr: |
        sum(trivy_image_vulnerabilities{severity="HIGH"}) > 5
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "High vulnerabilities detected in images"
        description: "{{ $value }} HIGH vulnerabilities found in container images"

    - alert: VulnerabilityDatabaseOutdated
      expr: |
        (time() - trivy_db_last_update_timestamp) > 86400
      for: 1h
      labels:
        severity: warning
      annotations:
        summary: "Trivy vulnerability database is outdated"
        description: "Database hasn't been updated in over 24 hours"

    - alert: ScanJobsFailing
      expr: |
        rate(trivy_scan_errors_total[5m]) > 0.1
      for: 15m
      labels:
        severity: warning
      annotations:
        summary: "Trivy scan jobs are failing"
        description: "{{ $value }} scan errors per second"

---
# ServiceMonitor for Trivy metrics
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: trivy-metrics
  namespace: trivy-system
  labels:
    app: trivy-operator
spec:
  selector:
    matchLabels:
      app: trivy-operator
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics

---
# Grafana Dashboard ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: trivy-dashboard
  namespace: trivy-system
  labels:
    grafana_dashboard: "1"
data:
  trivy-vulnerabilities.json: |
    {
      "dashboard": {
        "title": "Trivy Vulnerability Scanning",
        "panels": [
          {
            "title": "Vulnerabilities by Severity",
            "targets": [
              {
                "expr": "sum by (severity) (trivy_image_vulnerabilities)"
              }
            ],
            "type": "graph"
          },
          {
            "title": "Images with Critical Vulnerabilities",
            "targets": [
              {
                "expr": "count(trivy_image_vulnerabilities{severity=\"CRITICAL\"} > 0)"
              }
            ],
            "type": "stat"
          },
          {
            "title": "Top 10 Most Vulnerable Images",
            "targets": [
              {
                "expr": "topk(10, sum by (image) (trivy_image_vulnerabilities))"
              }
            ],
            "type": "table"
          },
          {
            "title": "Scan Success Rate",
            "targets": [
              {
                "expr": "rate(trivy_scan_success_total[5m]) / rate(trivy_scan_total[5m])"
              }
            ],
            "type": "gauge"
          }
        ]
      }
    }

---
# NetworkPolicy for Trivy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: trivy-network-policy
  namespace: trivy-system
spec:
  podSelector:
    matchLabels:
      app: trivy-operator
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 9115  # Metrics port
  egress:
  # Allow database updates
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 80
  # Allow DNS
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53
  # Allow access to container registries
  - to:
    - podSelector:
        matchLabels:
          app: harbor
      namespaceSelector:
        matchLabels:
          name: harbor-system
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 5000
