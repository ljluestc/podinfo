---
# Falco Runtime Security Monitoring
# Install via Helm:
# helm repo add falcosecurity https://falcosecurity.github.io/charts
# helm install falco falcosecurity/falco \
#   --namespace falco-system \
#   --create-namespace \
#   --set driver.kind=ebpf \
#   --set falcosidekick.enabled=true \
#   --set falcosidekick.webui.enabled=true

# Falco Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: falco-custom-rules
  namespace: falco-system
data:
  custom-rules.yaml: |
    # Custom Falco Rules for Kubernetes Security

    - rule: Unauthorized Process Started in Container
      desc: Detect unauthorized process execution in containers
      condition: >
        spawned_process and
        container and
        not proc.name in (allowed_processes)
      output: >
        Unauthorized process started in container
        (user=%user.name command=%proc.cmdline container=%container.name image=%container.image.repository)
      priority: WARNING
      tags: [process, container]

    - rule: Sensitive File Access
      desc: Detect access to sensitive files
      condition: >
        open_read and
        fd.name in (/etc/shadow, /etc/passwd, /root/.ssh/id_rsa) and
        not proc.name in (allowed_file_readers)
      output: >
        Sensitive file accessed
        (user=%user.name command=%proc.cmdline file=%fd.name container=%container.name)
      priority: CRITICAL
      tags: [filesystem, security]

    - rule: Suspicious Network Activity
      desc: Detect suspicious outbound connections
      condition: >
        outbound and
        fd.sip != "127.0.0.1" and
        not fd.sport in (allowed_ports)
      output: >
        Suspicious outbound connection
        (user=%user.name command=%proc.cmdline connection=%fd.name container=%container.name)
      priority: WARNING
      tags: [network, security]

    - rule: Container Drift Detection
      desc: Detect file modifications in running containers
      condition: >
        open_write and
        container and
        not fd.name startswith /tmp and
        not fd.name startswith /var/log
      output: >
        File modified in container (potential drift)
        (user=%user.name file=%fd.name container=%container.name image=%container.image.repository)
      priority: WARNING
      tags: [filesystem, drift]

    - rule: Privilege Escalation Attempt
      desc: Detect attempts to escalate privileges
      condition: >
        spawned_process and
        proc.name in (sudo, su, setuid) and
        container
      output: >
        Privilege escalation attempt detected
        (user=%user.name command=%proc.cmdline container=%container.name)
      priority: CRITICAL
      tags: [security, privilege]

    - rule: Crypto Mining Detection
      desc: Detect potential cryptocurrency mining activity
      condition: >
        spawned_process and
        (proc.name in (xmrig, minerd, cpuminer) or
         proc.cmdline contains "stratum+tcp")
      output: >
        Potential crypto mining detected
        (user=%user.name command=%proc.cmdline container=%container.name)
      priority: CRITICAL
      tags: [security, mining]

    - rule: Kubernetes Secret Access
      desc: Detect access to Kubernetes secrets
      condition: >
        open_read and
        fd.name startswith /var/run/secrets/kubernetes.io
      output: >
        Kubernetes secret accessed
        (user=%user.name command=%proc.cmdline file=%fd.name container=%container.name)
      priority: INFO
      tags: [kubernetes, secrets]

    - rule: Shell Spawned in Container
      desc: Detect interactive shell spawned in container
      condition: >
        spawned_process and
        container and
        proc.name in (bash, sh, zsh, fish) and
        proc.pname exists
      output: >
        Shell spawned in container
        (user=%user.name shell=%proc.name parent=%proc.pname container=%container.name image=%container.image.repository)
      priority: WARNING
      tags: [shell, container]

---
# Falco Alert Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: falco-alerts
  namespace: falco-system
data:
  alerts.yaml: |
    # Configure alert destinations

    # Slack webhook
    slack:
      webhookurl: "https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"
      minimumpriority: "warning"

    # Email alerts
    smtp:
      hostport: "smtp.example.com:587"
      user: "alerts@example.com"
      password: "password"
      from: "falco@example.com"
      to: "security-team@example.com"

    # Webhook for custom integrations
    webhook:
      address: "http://security-webhook.example.com/alerts"
      minimumpriority: "warning"

    # Syslog
    syslog:
      host: "syslog.example.com"
      port: 514
      protocol: "tcp"
