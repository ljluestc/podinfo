---
# KEDA (Kubernetes Event-Driven Autoscaling) Installation
# Install via Helm:
# helm repo add kedacore https://kedacore.github.io/charts
# helm install keda kedacore/keda --namespace keda --create-namespace \
#   --set prometheus.metricServer.enabled=true \
#   --set prometheus.operator.enabled=true

---
# KEDA Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: keda
  labels:
    name: keda

---
# ScaledObject for HTTP Request-Based Scaling
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: podinfo-http-scaler
  namespace: default
  labels:
    app: podinfo
    component: autoscaling
spec:
  scaleTargetRef:
    name: podinfo
    kind: Deployment
  minReplicaCount: 2
  maxReplicaCount: 20
  cooldownPeriod: 60
  pollingInterval: 15
  advanced:
    restoreToOriginalReplicaCount: false
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          stabilizationWindowSeconds: 300
          policies:
          - type: Percent
            value: 50
            periodSeconds: 60
        scaleUp:
          stabilizationWindowSeconds: 0
          policies:
          - type: Percent
            value: 100
            periodSeconds: 30
  triggers:
  # Prometheus-based HTTP request rate
  - type: prometheus
    metadata:
      serverAddress: http://prometheus.monitoring.svc.cluster.local:9090
      metricName: http_requests_per_second
      query: |
        sum(rate(http_requests_total{app="podinfo"}[2m]))
      threshold: "1000"

---
# ScaledObject for RabbitMQ Queue-Based Scaling
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: rabbitmq-consumer-scaler
  namespace: default
  labels:
    app: rabbitmq-consumer
    component: autoscaling
spec:
  scaleTargetRef:
    name: rabbitmq-consumer
    kind: Deployment
  minReplicaCount: 1
  maxReplicaCount: 30
  cooldownPeriod: 300
  pollingInterval: 30
  triggers:
  - type: rabbitmq
    metadata:
      protocol: auto
      queueName: tasks
      mode: QueueLength
      value: "10"  # 10 messages per pod
      activationValue: "5"  # Start scaling at 5 messages
    authenticationRef:
      name: rabbitmq-trigger-auth

---
# TriggerAuthentication for RabbitMQ
apiVersion: keda.sh/v1alpha1
kind: TriggerAuthentication
metadata:
  name: rabbitmq-trigger-auth
  namespace: default
spec:
  secretTargetRef:
  - parameter: host
    name: rabbitmq-secret
    key: host

---
# ScaledObject for Kafka Topic-Based Scaling
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: kafka-consumer-scaler
  namespace: default
  labels:
    app: kafka-consumer
    component: autoscaling
spec:
  scaleTargetRef:
    name: kafka-consumer
    kind: Deployment
  minReplicaCount: 1
  maxReplicaCount: 50
  cooldownPeriod: 300
  pollingInterval: 30
  triggers:
  - type: kafka
    metadata:
      bootstrapServers: kafka.default.svc.cluster.local:9092
      consumerGroup: my-consumer-group
      topic: events
      lagThreshold: "100"
      activationLagThreshold: "50"
      offsetResetPolicy: latest
    authenticationRef:
      name: kafka-trigger-auth

---
# TriggerAuthentication for Kafka
apiVersion: keda.sh/v1alpha1
kind: TriggerAuthentication
metadata:
  name: kafka-trigger-auth
  namespace: default
spec:
  secretTargetRef:
  - parameter: sasl
    name: kafka-secret
    key: sasl
  - parameter: username
    name: kafka-secret
    key: username
  - parameter: password
    name: kafka-secret
    key: password

---
# ScaledObject for AWS SQS Queue-Based Scaling
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: sqs-processor-scaler
  namespace: default
  labels:
    app: sqs-processor
    component: autoscaling
spec:
  scaleTargetRef:
    name: sqs-processor
    kind: Deployment
  minReplicaCount: 0  # Scale to zero when queue is empty
  maxReplicaCount: 100
  cooldownPeriod: 300
  pollingInterval: 30
  triggers:
  - type: aws-sqs-queue
    metadata:
      queueURL: https://sqs.us-east-1.amazonaws.com/123456789/my-queue
      queueLength: "5"
      awsRegion: us-east-1
      identityOwner: operator
    authenticationRef:
      name: aws-sqs-auth

---
# TriggerAuthentication for AWS SQS
apiVersion: keda.sh/v1alpha1
kind: TriggerAuthentication
metadata:
  name: aws-sqs-auth
  namespace: default
spec:
  podIdentity:
    provider: aws-eks  # Use IRSA

---
# ScaledObject for Redis List-Based Scaling
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: redis-worker-scaler
  namespace: default
  labels:
    app: redis-worker
    component: autoscaling
spec:
  scaleTargetRef:
    name: redis-worker
    kind: Deployment
  minReplicaCount: 1
  maxReplicaCount: 25
  cooldownPeriod: 180
  pollingInterval: 15
  triggers:
  - type: redis
    metadata:
      address: redis.default.svc.cluster.local:6379
      listName: job-queue
      listLength: "10"
      activationListLength: "5"
      databaseIndex: "0"
    authenticationRef:
      name: redis-trigger-auth

---
# TriggerAuthentication for Redis
apiVersion: keda.sh/v1alpha1
kind: TriggerAuthentication
metadata:
  name: redis-trigger-auth
  namespace: default
spec:
  secretTargetRef:
  - parameter: password
    name: redis-secret
    key: password

---
# ScaledObject for Cron-Based Scaling
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: cron-scaler
  namespace: default
  labels:
    app: scheduled-job
    component: autoscaling
spec:
  scaleTargetRef:
    name: scheduled-processor
    kind: Deployment
  minReplicaCount: 0
  maxReplicaCount: 10
  triggers:
  - type: cron
    metadata:
      timezone: America/New_York
      start: "0 8 * * *"  # Scale up at 8 AM
      end: "0 18 * * *"   # Scale down at 6 PM
      desiredReplicas: "5"

---
# ScaledObject for CPU-Based Scaling with KEDA
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: cpu-based-scaler
  namespace: default
  labels:
    app: cpu-intensive
    component: autoscaling
spec:
  scaleTargetRef:
    name: cpu-processor
    kind: Deployment
  minReplicaCount: 2
  maxReplicaCount: 20
  cooldownPeriod: 120
  pollingInterval: 30
  triggers:
  - type: cpu
    metricType: Utilization
    metadata:
      value: "70"

---
# ScaledObject for Memory-Based Scaling with KEDA
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: memory-based-scaler
  namespace: default
  labels:
    app: memory-intensive
    component: autoscaling
spec:
  scaleTargetRef:
    name: memory-processor
    kind: Deployment
  minReplicaCount: 2
  maxReplicaCount: 15
  cooldownPeriod: 180
  pollingInterval: 30
  triggers:
  - type: memory
    metricType: Utilization
    metadata:
      value: "75"

---
# ScaledObject for PostgreSQL Queue Table
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: postgres-queue-scaler
  namespace: default
  labels:
    app: postgres-worker
    component: autoscaling
spec:
  scaleTargetRef:
    name: postgres-worker
    kind: Deployment
  minReplicaCount: 1
  maxReplicaCount: 20
  cooldownPeriod: 300
  pollingInterval: 30
  triggers:
  - type: postgresql
    metadata:
      query: "SELECT COUNT(*) FROM jobs WHERE status='pending'"
      targetQueryValue: "10"
      activationQueryValue: "5"
      connectionFromEnv: POSTGRES_CONNECTION
    authenticationRef:
      name: postgres-trigger-auth

---
# TriggerAuthentication for PostgreSQL
apiVersion: keda.sh/v1alpha1
kind: TriggerAuthentication
metadata:
  name: postgres-trigger-auth
  namespace: default
spec:
  secretTargetRef:
  - parameter: connection
    name: postgres-secret
    key: connection_string

---
# ScaledJob for Event-Driven Batch Processing
apiVersion: keda.sh/v1alpha1
kind: ScaledJob
metadata:
  name: batch-job-scaler
  namespace: default
  labels:
    app: batch-processor
    component: autoscaling
spec:
  jobTargetRef:
    template:
      spec:
        containers:
        - name: processor
          image: batch-processor:latest
          env:
          - name: TASK_ID
            value: "$(JOB_NAME)"
        restartPolicy: Never
  pollingInterval: 30
  maxReplicaCount: 100
  successfulJobsHistoryLimit: 5
  failedJobsHistoryLimit: 5
  scalingStrategy:
    strategy: default
  triggers:
  - type: rabbitmq
    metadata:
      queueName: batch-tasks
      mode: QueueLength
      value: "1"  # One job per message
    authenticationRef:
      name: rabbitmq-trigger-auth

---
# ScaledObject with Multiple Triggers (AND logic)
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: multi-trigger-scaler
  namespace: default
  labels:
    app: multi-metric
    component: autoscaling
spec:
  scaleTargetRef:
    name: api-gateway
    kind: Deployment
  minReplicaCount: 2
  maxReplicaCount: 30
  cooldownPeriod: 180
  pollingInterval: 15
  triggers:
  # CPU trigger
  - type: cpu
    metricType: Utilization
    metadata:
      value: "70"
  # Prometheus request rate
  - type: prometheus
    metadata:
      serverAddress: http://prometheus.monitoring.svc.cluster.local:9090
      metricName: request_rate
      query: sum(rate(http_requests_total[2m]))
      threshold: "500"
  # Prometheus error rate
  - type: prometheus
    metadata:
      serverAddress: http://prometheus.monitoring.svc.cluster.local:9090
      metricName: error_rate
      query: sum(rate(http_errors_total[2m]))
      threshold: "10"

---
# KEDA Metrics API Service for HPA Integration
apiVersion: v1
kind: Service
metadata:
  name: keda-metrics-apiserver
  namespace: keda
  labels:
    app: keda-metrics-apiserver
spec:
  ports:
  - name: https
    port: 443
    targetPort: 6443
  selector:
    app: keda-metrics-apiserver
