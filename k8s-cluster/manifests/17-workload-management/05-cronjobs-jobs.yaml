---
# CronJob for Database Backup
apiVersion: batch/v1
kind: CronJob
metadata:
  name: database-backup
  namespace: workload-demo
  labels:
    app: database-backup
    workload-type: cronjob
spec:
  schedule: "0 2 * * *"  # Daily at 2 AM
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 5
  concurrencyPolicy: Forbid
  startingDeadlineSeconds: 300
  suspend: false
  jobTemplate:
    spec:
      backoffLimit: 3
      activeDeadlineSeconds: 3600
      ttlSecondsAfterFinished: 86400  # Keep for 24 hours
      template:
        metadata:
          labels:
            app: database-backup
            job-type: backup
        spec:
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            runAsUser: 70
            fsGroup: 70
            seccompProfile:
              type: RuntimeDefault
          containers:
          - name: backup
            image: postgres:16-alpine
            imagePullPolicy: IfNotPresent
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
              runAsNonRoot: true
              runAsUser: 70
              capabilities:
                drop:
                - ALL
            command:
            - /bin/sh
            - -c
            - |
              set -e
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              BACKUP_FILE="/backups/backup_${TIMESTAMP}.sql"
              echo "Starting backup at $(date)"
              pg_dump -h postgresql.workload-demo.svc.cluster.local \
                      -U $POSTGRES_USER \
                      -d $POSTGRES_DB \
                      -F c \
                      -f $BACKUP_FILE
              echo "Backup completed: $BACKUP_FILE"
              echo "Backup size: $(du -h $BACKUP_FILE | cut -f1)"
              # Keep only last 7 backups
              ls -t /backups/backup_*.sql | tail -n +8 | xargs -r rm
              echo "Cleanup completed"
            env:
            - name: POSTGRES_DB
              value: podinfo
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: postgresql-credentials
                  key: username
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgresql-credentials
                  key: password
            resources:
              limits:
                cpu: 500m
                memory: 512Mi
              requests:
                cpu: 100m
                memory: 128Mi
            volumeMounts:
            - name: backups
              mountPath: /backups
          volumes:
          - name: backups
            persistentVolumeClaim:
              claimName: backup-storage
---
# PVC for Backup Storage
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: backup-storage
  namespace: workload-demo
  labels:
    app: database-backup
spec:
  accessModes:
  - ReadWriteOnce
  storageClassName: fast-ssd
  resources:
    requests:
      storage: 50Gi
---
# CronJob for Cache Cleanup
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cache-cleanup
  namespace: workload-demo
  labels:
    app: cache-cleanup
    workload-type: cronjob
spec:
  schedule: "*/30 * * * *"  # Every 30 minutes
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Replace
  startingDeadlineSeconds: 200
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 300
      ttlSecondsAfterFinished: 3600
      template:
        metadata:
          labels:
            app: cache-cleanup
            job-type: cleanup
        spec:
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            runAsUser: 999
            fsGroup: 999
            seccompProfile:
              type: RuntimeDefault
          containers:
          - name: cleanup
            image: redis:7.2-alpine
            imagePullPolicy: IfNotPresent
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              runAsNonRoot: true
              runAsUser: 999
              capabilities:
                drop:
                - ALL
            command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "Starting cache cleanup at $(date)"
              # Connect to Redis and clean expired keys
              redis-cli -h redis-cluster-client.workload-demo.svc.cluster.local \
                        -p 6379 \
                        --scan --pattern "cache:*" | \
              while read key; do
                TTL=$(redis-cli -h redis-cluster-client.workload-demo.svc.cluster.local \
                                -p 6379 TTL "$key")
                if [ "$TTL" = "-1" ]; then
                  echo "Setting TTL for key: $key"
                  redis-cli -h redis-cluster-client.workload-demo.svc.cluster.local \
                            -p 6379 EXPIRE "$key" 3600
                fi
              done
              echo "Cache cleanup completed at $(date)"
            resources:
              limits:
                cpu: 200m
                memory: 128Mi
              requests:
                cpu: 50m
                memory: 32Mi
            volumeMounts:
            - name: tmp
              mountPath: /tmp
          volumes:
          - name: tmp
            emptyDir: {}
---
# CronJob for Log Rotation
apiVersion: batch/v1
kind: CronJob
metadata:
  name: log-rotation
  namespace: workload-demo
  labels:
    app: log-rotation
    workload-type: cronjob
spec:
  schedule: "0 0 * * 0"  # Weekly on Sunday at midnight
  successfulJobsHistoryLimit: 2
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 1800
      ttlSecondsAfterFinished: 604800  # Keep for 7 days
      template:
        metadata:
          labels:
            app: log-rotation
            job-type: maintenance
        spec:
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            runAsUser: 65534
            fsGroup: 65534
            seccompProfile:
              type: RuntimeDefault
          containers:
          - name: rotate
            image: busybox:1.36
            imagePullPolicy: IfNotPresent
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              runAsNonRoot: true
              runAsUser: 65534
              capabilities:
                drop:
                - ALL
            command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "Starting log rotation at $(date)"
              echo "Simulating log rotation and compression"
              echo "Log rotation completed at $(date)"
            resources:
              limits:
                cpu: 100m
                memory: 64Mi
              requests:
                cpu: 10m
                memory: 16Mi
            volumeMounts:
            - name: tmp
              mountPath: /tmp
          volumes:
          - name: tmp
            emptyDir: {}
---
# One-time Job for Database Migration
apiVersion: batch/v1
kind: Job
metadata:
  name: database-migration
  namespace: workload-demo
  labels:
    app: database-migration
    workload-type: job
spec:
  backoffLimit: 4
  activeDeadlineSeconds: 600
  ttlSecondsAfterFinished: 3600
  completions: 1
  parallelism: 1
  template:
    metadata:
      labels:
        app: database-migration
        job-type: migration
    spec:
      restartPolicy: OnFailure
      securityContext:
        runAsNonRoot: true
        runAsUser: 70
        fsGroup: 70
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: migrate
        image: postgres:16-alpine
        imagePullPolicy: IfNotPresent
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          runAsNonRoot: true
          runAsUser: 70
          capabilities:
            drop:
            - ALL
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Starting database migration at $(date)"

          # Wait for database to be ready
          until pg_isready -h postgresql.workload-demo.svc.cluster.local -U $POSTGRES_USER -d $POSTGRES_DB; do
            echo "Waiting for database..."
            sleep 2
          done

          echo "Database is ready, running migrations"

          # Create tables
          psql -h postgresql.workload-demo.svc.cluster.local \
               -U $POSTGRES_USER \
               -d $POSTGRES_DB <<EOF
          CREATE TABLE IF NOT EXISTS migrations (
            id SERIAL PRIMARY KEY,
            version VARCHAR(255) NOT NULL,
            applied_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );

          CREATE TABLE IF NOT EXISTS users (
            id SERIAL PRIMARY KEY,
            username VARCHAR(255) NOT NULL UNIQUE,
            email VARCHAR(255) NOT NULL UNIQUE,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );

          INSERT INTO migrations (version) VALUES ('v1.0.0');
          EOF

          echo "Migration completed successfully at $(date)"
        env:
        - name: POSTGRES_DB
          value: podinfo
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: postgresql-credentials
              key: username
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: postgresql-credentials
              key: password
        resources:
          limits:
            cpu: 500m
            memory: 256Mi
          requests:
            cpu: 100m
            memory: 64Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
      volumes:
      - name: tmp
        emptyDir: {}
---
# Parallel Job for Data Processing
apiVersion: batch/v1
kind: Job
metadata:
  name: data-processing
  namespace: workload-demo
  labels:
    app: data-processing
    workload-type: job
spec:
  backoffLimit: 3
  activeDeadlineSeconds: 1800
  ttlSecondsAfterFinished: 7200
  completions: 5
  parallelism: 3
  completionMode: Indexed
  template:
    metadata:
      labels:
        app: data-processing
        job-type: processing
    spec:
      restartPolicy: OnFailure
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 2000
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: processor
        image: busybox:1.36
        imagePullPolicy: IfNotPresent
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 1000
          capabilities:
            drop:
            - ALL
        command:
        - /bin/sh
        - -c
        - |
          set -e
          JOB_INDEX=${JOB_COMPLETION_INDEX:-0}
          echo "Processing job index: $JOB_INDEX"
          echo "Started at $(date)"

          # Simulate data processing
          sleep $((10 + RANDOM % 20))

          echo "Completed job index $JOB_INDEX at $(date)"
        resources:
          limits:
            cpu: 200m
            memory: 128Mi
          requests:
            cpu: 50m
            memory: 32Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
      volumes:
      - name: tmp
        emptyDir: {}
